@model Product
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.AspNetCore.Identity;
@inject IHtmlLocalizer<SharedResource> Localizer
@inject UserManager<ApplicationUser> userManager
@{
    ViewData["Title"] = @Model.Title;
    var appUser = await userManager.GetUserAsync(User);
    var type = Model.GetType().Name;
    string? trailer = null;
    if (type != "Book")
    {
        if (Model is Movie movie) trailer = movie.Trailer;
        else if (Model is Series series) trailer = series.Trailer;
        else if (Model is Game game) trailer = game.Trailer;
    }
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md">
            <h1>@Model.Title</h1>
            @if (Model is Book b)
            {
                <h3>@b.Author</h3>
            }
            <h4>@type - @Model.ReleaseYear</h4>
        </div>
        <div class="col-md text-end">
            <h1>
                @if (Model.AverageReviewScore > 7)
                {
                    <span class="badge bg-success">
                        @Model.AverageReviewScore/10
                    </span>
                }
                else if (Model.AverageReviewScore > 0)
                {
                    <span class="badge bg-warning">
                        @Model.AverageReviewScore/10
                    </span>
                }
                else
                {
                    <span class="badge bg-secondary">n/10</span>
                }
                @if (Model.AverageUserScore > 3.5)
                {
                    <span class="badge bg-success">
                        @Model.AverageUserScore/5
                    </span>
                }
                else if (Model.AverageUserScore > 0)
                {
                    <span class="badge bg-warning">
                        @Model.AverageUserScore/5
                    </span>
                }
                else
                {
                    <span class="badge bg-secondary">n/5</span>
                }
            </h1>
            <h5>Your score</h5>
            @if (appUser != null)
            {
                for (int i = 1; i <= 5; i++)
                {
                    <a role="button" class="btn btn-sm btn-light mb-1" style="max-width:26px; max-height:26px" name="rateBtn" onclick="changeRateProd('@i', '@Model.Id')">
                        <img src="~/icons/star.svg" style="max-width:20px; max-height:20px" aria-hidden="true" />
                    </a>
                }
                var s = Model.UserScores.SingleOrDefault(s => s.Sender == appUser);
                if (s != null)
                {
                    <script>
                        setInitRateProd('@s.Value');
                    </script>
                }
            }
            else for (int i = 1; i <= 5; i++)
                {
                    <a class="btn btn-sm btn-light mb-1" style="max-width:26px; max-height:26px" asp-area="Identity" asp-page="/Account/Login">
                        <img src="~/icons/star.svg" style="max-width:20px; max-height:20px" aria-hidden="true" />
                    </a>
                }
        </div>
    </div>
    <hr />
    <div class="row g-2">
        @if (Model.Cover?.Length > 0)
        {
            <div class="col-md-3 mb-3">
                <img src="@Model.Cover" style="width:100%;"/>
            </div>
        }
        @if (trailer?.Length > 0)
        {
            <div class="col-md-9 mb-3">
                <div class="ratio ratio-16x9">
                    <iframe src="@trailer" allowfullscreen="allowfullscreen"></iframe>
                </div>
            </div>
        }
        <div class="col-md">
            <h5>@Model.Description</h5>
        </div>
    </div>
    <hr />
    <div class="row">
        <div class="col">
            <h3>User reviews <small class="text-muted" style="font-size:large">@Model.Reviews?.Count</small></h3>
        </div>
        <div class="col text-end">
            <a class="btn btn-primary" asp-action="AddReview" asp-controller="Review">Write a review</a>
        </div>
    </div>
    @if (Model.Reviews?.Count > 0)
    {
        <div class="row">
            <table id="prodReviews" class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>Author</th>
                        <th>Title</th>
                        <th>Score</th>
                        <th>Likes</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Model.Reviews.OrderByDescending(r => r.LikeCounter))
                    {
                        <tr>
                            <td>
                                <a asp-controller="User" asp-action="Index" asp-route-id="@r.AuthorId">
                                    @r.Author.UserName
                                </a>
                            </td>
                            <td>
                                <a class="h-100 w-100 text-start btn" asp-controller="Review" asp-action="Index" asp-route-id="@r.Id">
                                    @r.Title
                                </a>
                            </td>
                            <td>
                                @if (r.Score.Value >= 7)
                                {
                                    <span class="badge text-bg-success align-middle" style="min-width:45px; font-size:medium">
                                        @r.Score.Value
                                    </span>
                                }
                                else
                                {
                                    <span class="badge text-bg-warning align-middle" style="min-width:45px; font-size:medium">
                                        @r.Score.Value
                                    </span>
                                }
                            </td>
                            <td>
                                <span class="badge text-bg-secondary align-middle" style="min-width:45px; font-size:medium">
                                    <img src="~/icons/thumb white full.svg" aria-label="Likes" style="max-width:14px; max-height:14px;">
                                    @r.LikeCounter
                                </span>
                            </td>
                            <td>@r.PublicationDate.ToString("dd/MM/yy")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
